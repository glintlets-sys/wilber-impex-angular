<!-- Header -->
<div class="d-flex justify-content-between align-items-center mb-4">
  <h3 class="panel-title">
    <i class="fas fa-boxes me-2"></i>Products Management
  </h3>
  <span class="pull-right">
    <button type="button" class="btn btn-primary me-2" (click)="exportProducts()">
      <i class="fas fa-download me-1"></i>Export Products
    </button>
    <button type="button" class="btn btn-primary me-2" (click)="importProducts()">
      <i class="fas fa-upload me-1"></i>Import Products
    </button>
    <button type="button" class="btn btn-primary me-2" (click)="refreshData()" [disabled]="isLoading">
      <i class="fas fa-sync me-1" [class.fa-spin]="isLoading"></i>Refresh
    </button>
    <button type="button" class="btn btn-primary" (click)="addNewProduct()">
      <i class="fas fa-plus me-1"></i>Add Product
    </button>
  </span>
</div>

<!-- Import/Export Help -->
<div class="alert alert-info mb-3" role="alert">
  <div class="d-flex align-items-center">
    <i class="fas fa-info-circle me-2"></i>
    <div>
      <strong>Import/Export Guide:</strong>
      <ul class="mb-0 mt-1">
        <li><strong>Export:</strong> Downloads all products as CSV with stock information</li>
        <li><strong>Import:</strong> Upload CSV file with columns: Name, Code, Price (Brand, Description, Status, Discount % are optional)</li>
        <li><strong>Format:</strong> Products with existing codes will be updated, new codes will create new products</li>
      </ul>
    </div>
  </div>
</div>

<!-- Search and Filters -->
<div class="row mb-3">
  <div class="col-md-4">
    <input 
      type="text" 
      class="form-control" 
      placeholder="Search products..." 
      [(ngModel)]="searchTerm" 
      (keyup)="applyFilters()">
  </div>
  <div class="col-md-2">
    <select 
      class="form-control" 
      [(ngModel)]="selectedStatus" 
      (change)="applyFilters()">
      <option value="">All Status</option>
      <option value="active">Active</option>
      <option value="inactive">Inactive</option>
    </select>
  </div>
  <div class="col-md-2">
    <select 
      class="form-control" 
      (change)="onTableSizeChange($event)">
      <option [value]="5">5 per page</option>
      <option [value]="10" selected>10 per page</option>
      <option [value]="20">20 per page</option>
      <option [value]="50">50 per page</option>
    </select>
  </div>
  <div class="col-md-4">
    <span class="item_count">Total: {{ count }} products</span>
  </div>
</div>

<!-- Loading State -->
<div *ngIf="isLoading" class="row mb-3">
  <div class="col-12">
    <div class="alert alert-primary">
      <i class="fas fa-spinner fa-spin me-2"></i>
      Loading products from backend...
    </div>
  </div>
</div>

<!-- Products Table -->
<table class="table table-bordered">
  <thead class="table-light">
    <tr>
      <th>Image</th>
      <th>Name</th>
      <th>Code</th>
      <th>Brand</th>
      <th>Price</th>
      <th>Stock Information</th>
      <th>Status</th>
      <th>Actions</th>
    </tr>
  </thead>
  <tbody>
    <tr *ngFor="let product of paginatedProducts">
      <td>
        <img 
          [src]="getProductThumbnail(product)" 
          (error)="$event.target.src='assets/images/image_empty.jpg'"
          [alt]="getProductName(product)" 
          class="img-thumbnail product-image"
          style="width: 50px; height: 50px; object-fit: cover;">
      </td>
      <td>
        <strong>{{ getProductName(product) }}</strong>
        <br>
        <small class="text-muted" *ngIf="getProductDescription(product) && getProductDescription(product).trim().length > 0">
          {{ getProductDescription(product).length > 50 ? (getProductDescription(product) | slice:0:50) + '...' : getProductDescription(product) }}
        </small>
        <small class="text-muted" *ngIf="!getProductDescription(product) || getProductDescription(product).trim().length === 0">
          No description available
        </small>
      </td>
      <td>{{ product.code || 'N/A' }}</td>
      <td>{{ product.brand || 'N/A' }}</td>
      <td>
        <strong>â‚¹{{ product.price?.amount || 0 }}</strong>
        <span *ngIf="product.discount && product.discount.discountPercent > 0" class="text-success">
          <br><small>{{ product.discount.discountPercent }}% off</small>
        </span>
      </td>
      <td>
        <div [class]="getStockStatusClass(product.id)">
          <small>{{ getStockDisplay(product.id) }}</small>
        </div>
      </td>
      <td>
        <div class="form-check form-switch d-flex justify-content-center">
          <input 
            class="form-check-input status-toggle" 
            type="checkbox" 
            [checked]="product.notAvailable"
            (change)="toggleProductAvailability(product)"
            [id]="'toggle-' + product.id"
            [class.toggle-active]="product.notAvailable"
            [class.toggle-inactive]="!product.notAvailable"
            title="Click to toggle availability">
        </div>
      </td>
      <td>
        <div class="btn-group" role="group">
          <button class="btn btn-sm btn-outline-info" type="button" (click)="viewProductDetails(product)" title="View Details">
            <i class="fa fa-eye"></i>
          </button>
          <button class="btn btn-sm btn-outline-primary" type="button" (click)="editProduct(product)" title="Edit Product">
            <i class="fa fa-edit"></i>
          </button>
          <button class="btn btn-sm btn-outline-danger" type="button" (click)="deleteProduct(product)" title="Delete Product">
            <i class="fa fa-trash"></i>
          </button>
        </div>
      </td>
    </tr>
  </tbody>
</table>

<!-- Empty State -->
<div *ngIf="filteredProducts.length === 0 && !isLoading" class="text-center py-5">
  <div class="no-record-found">
    <i class="fas fa-search fa-3x mb-3 text-muted"></i>
    <h5>No Products Found</h5>
    <p class="text-muted">
      <span *ngIf="searchTerm || selectedStatus">Try adjusting your search filters.</span>
      <span *ngIf="!searchTerm && !selectedStatus">No products available in the backend.</span>
    </p>
  </div>
</div>

<!-- Pagination -->
<div *ngIf="filteredProducts.length > 0" class="d-flex justify-content-between align-items-center mt-4">
  <div class="pagination-info">
    <small class="text-muted">
      Showing {{ (page - 1) * tableSize + 1 }} to {{ Math.min(page * tableSize, count) }} of {{ count }} products
    </small>
  </div>
  
  <nav aria-label="Products pagination">
    <ul class="pagination pagination-sm mb-0">
      <!-- Previous button -->
      <li class="page-item" [class.disabled]="page === 1">
        <button class="page-link" (click)="onTableDataChange(page - 1)" [disabled]="page === 1">
          <i class="fas fa-chevron-left"></i>
        </button>
      </li>
      
      <!-- Page numbers -->
      <li class="page-item" *ngFor="let pageNum of getPageNumbers()" [class.active]="pageNum === page">
        <button class="page-link" (click)="onTableDataChange(pageNum)">
          {{ pageNum }}
        </button>
      </li>
      
      <!-- Next button -->
      <li class="page-item" [class.disabled]="page >= getTotalPages()">
        <button class="page-link" (click)="onTableDataChange(page + 1)" [disabled]="page >= getTotalPages()">
          <i class="fas fa-chevron-right"></i>
        </button>
      </li>
    </ul>
  </nav>
</div>